{% extends 'base.html' %}

{% block content %}
<div x-data="searchApp()" x-init="loadExcipientCategories()" class="space-y-6">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Medication Excipient Search Tool</h1>
        <p class="text-sm text-gray-600 dark:text-gray-400">Powered by DailyMed</p>
    </div>

    <!-- Search Form - Step 1: Enter Drug Name -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Step 1: Enter Drug Name or NDC</h2>
        
        <!-- Drug Name Search -->
        <div class="mb-4">
            <label for="drug-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Enter drug, NDC code, drug class, or Set ID
            </label>
            <div class="relative">
                <input
                    type="text"
                    id="drug-search"
                    x-model="drugQuery"
                    @input="handleDrugInput($event)"
                    @focus="if (suggestions.length > 0) showSuggestions = true"
                    @blur="setTimeout(() => showSuggestions = false, 300)"
                    placeholder="Enter drug name, NDC code, drug class, or Set ID"
                    class="w-full px-4 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                />
                
                <!-- Loading Spinner -->
                <div 
                    x-show="autocompleteLoading"
                    x-cloak
                    class="absolute right-3 top-1/2 transform -translate-y-1/2"
                    style="display: none;"
                >
                    <svg class="animate-spin h-5 w-5 text-blue-600 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                
                <!-- Autocomplete Suggestions -->
                <div
                    x-show="showSuggestions && suggestions.length > 0"
                    x-cloak
                    class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-auto"
                    style="display: none;"
                >
                    <template x-for="(suggestion, index) in suggestions" :key="index">
                        <div
                            @click="selectDrug(suggestion)"
                            @mousedown.prevent
                            class="px-4 py-2 hover:bg-blue-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0"
                        >
                            <div class="font-medium text-gray-900 dark:text-white" x-text="suggestion.label"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Identify Excipients to Avoid (Optional) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Step 2: Identify Excipients to Avoid (Optional)</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Select excipients from categories below to filter results. This step is optional.
        </p>
        
        <!-- Excipient Search Box -->
        <div class="mb-4">
            <input
                type="text"
                x-model="excipientSearchQuery"
                @input="filterExcipientCategories()"
                placeholder="Search excipients..."
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
            />
        </div>

        <!-- Excipient Categories with Expand/Collapse -->
        <div class="space-y-2 max-h-96 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded p-4">
            <template x-for="(excipients, category) in filteredExcipientCategories" :key="category">
                <div class="border-b border-gray-200 dark:border-gray-700 pb-2 last:border-b-0">
                    <!-- Category Header with Expand/Collapse -->
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <button
                                type="button"
                                @click="toggleCategoryExpanded(category)"
                                class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
                            >
                                <svg 
                                    x-show="!isCategoryExpanded(category)"
                                    class="w-4 h-4" 
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                >
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                                <svg 
                                    x-show="isCategoryExpanded(category)"
                                    class="w-4 h-4" 
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                >
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    :checked="isCategoryFullySelected(category)"
                                    @change="toggleCategorySelectAll(category)"
                                    class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 dark:bg-gray-700"
                                />
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-200" x-text="category"></span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">
                                    (<span x-text="getCategorySelectedCount(category).selected"></span>/<span x-text="getCategorySelectedCount(category).total"></span>)
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Excipient List (Expandable) -->
                    <div x-show="isCategoryExpanded(category)" class="ml-6 mt-2 space-y-1 max-h-48 overflow-y-auto">
                        <template x-for="excipient in excipients" :key="excipient">
                            <label class="flex items-center space-x-2 px-2 py-1 hover:bg-gray-50 dark:hover:bg-gray-700 rounded cursor-pointer">
                                <input
                                    type="checkbox"
                                    :checked="isExcipientSelected(category, excipient)"
                                    @change="toggleExcipient(category, excipient)"
                                    class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 dark:bg-gray-700"
                                />
                                <span class="text-sm text-gray-700 dark:text-gray-300" x-text="excipient"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <!-- Selected Excipients Summary -->
        <div x-show="totalSelectedExcipients > 0" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
            <p class="text-sm font-medium text-blue-900 dark:text-blue-200">
                <span x-text="totalSelectedExcipients"></span> excipient<span x-text="totalSelectedExcipients !== 1 ? 's' : ''"></span> selected
            </p>
        </div>
    </div>
    
    <!-- Search Button -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <button
            type="button"
            @click="performSearch()"
            :disabled="!canSearch()"
            class="w-full px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:text-gray-500 disabled:cursor-not-allowed text-lg font-medium transition-colors"
        >
            <span x-show="!searching">Search</span>
            <span x-show="searching">Searching...</span>
        </button>
    </div>
    
    <!-- Loading Animation -->
    <div x-show="searching" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center mb-6" x-cloak>
        <div class="flex flex-col items-center justify-center space-y-4">
            <div class="relative w-16 h-16">
                <div class="absolute top-0 left-0 w-full h-full border-4 border-blue-200 dark:border-blue-800 rounded-full"></div>
                <div class="absolute top-0 left-0 w-full h-full border-4 border-blue-600 dark:border-blue-400 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <div class="text-gray-700 dark:text-gray-300">
                <p class="font-medium">Searching...</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-text="searchStatus"></p>
            </div>
        </div>
    </div>
    
    <!-- Results Container -->
    <div x-show="hasSearched && (hasResults || (!searching && resultsMetadata.total === 0))" class="space-y-6">
        <!-- Results Header with Metrics and Filters -->
        <div x-show="hasResults" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <!-- Search Query Display -->
            <div class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-blue-700 dark:text-blue-400">
                    SEARCH RESULTS FOR: <span x-text="selectedDrug || drugQuery"></span> 
                    (<span x-text="resultsMetadata.total"></span> results)
                </h2>
            </div>

            <!-- Metrics -->
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="text-center p-3 bg-gray-50 dark:bg-gray-900 rounded">
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" x-text="resultsMetadata.total"></div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Total # drugs found</div>
                </div>
                <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded">
                    <div class="text-2xl font-bold text-green-700 dark:text-green-400" x-text="resultsMetadata.total_free"></div>
                    <div class="text-sm text-gray-600 dark:text-gray-400"># without excipient(s)</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded">
                    <div class="text-2xl font-bold text-yellow-700 dark:text-yellow-400" x-text="resultsMetadata.total_with"></div>
                    <div class="text-sm text-gray-600 dark:text-gray-400"># with excipient(s)</div>
                </div>
            </div>

            <!-- Filter and Sort Controls -->
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <!-- Filter: Show All / Show Only Without Excipients -->
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Filter:</span>
                    <label class="flex items-center space-x-2">
                        <input
                            type="radio"
                            x-model="resultsFilter"
                            value="all"
                            class="text-blue-600 focus:ring-blue-500"
                        />
                        <span class="text-sm text-gray-700 dark:text-gray-300">Show all</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input
                            type="radio"
                            x-model="resultsFilter"
                            value="without"
                            class="text-blue-600 focus:ring-blue-500"
                        />
                        <span class="text-sm text-gray-700 dark:text-gray-300">Show only drugs without excipients</span>
                    </label>
                </div>

                <!-- Sort Dropdown -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Sort By:</label>
                    <select
                        x-model="sortBy"
                        @change="sortResults()"
                        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="relevance">Relevance</option>
                        <option value="name">Drug Name</option>
                        <option value="packager">Packager</option>
                    </select>
                </div>

                <!-- Results Per Page -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Results per page:</label>
                    <select
                        x-model="itemsPerPage"
                        @change="currentPage = 1"
                        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Section 1: Drugs Without Excipients -->
        <div x-show="filteredResultsFree.length > 0">
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-semibold text-green-800 dark:text-green-300 mb-2">
                    Section 1: Drugs Without Excipients (<span x-text="resultsMetadata.total_free"></span>)
                </h3>
                <p class="text-sm text-green-700 dark:text-green-400">
                    Based upon DailyMed results, these medications did not have the excipients you selected. 
                    Click on "View on DailyMed" to verify on the NIH DailyMed website.
                </p>
            </div>
            <div class="space-y-4">
                <template x-for="result in paginatedResultsFree" :key="result.set_id">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-green-500">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-semibold text-gray-900 dark:text-white" x-text="result.title"></h4>
                            <a
                                :href="result.dailymed_link"
                                target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                            >
                                View on DailyMed →
                            </a>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Dosage:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.dosage"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Route:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.route_code_display"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Packager:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.packager"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Drug Type:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.drug_type"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">NDC:</span>
                                <div class="text-sm text-gray-900 dark:text-gray-100 ml-2">
                                    <template x-if="result.ndc_count && result.ndc_count > 1">
                                        <div>
                                            <div class="font-medium mb-1">
                                                <span x-text="result.ndc_count"></span> NDC codes:
                                            </div>
                                            <ul class="list-disc list-inside ml-2">
                                                <template x-for="(ndc, idx) in result.ndcs" :key="idx">
                                                    <li x-text="ndc"></li>
                                                </template>
                                            </ul>
                                        </div>
                                    </template>
                                    <template x-if="!result.ndc_count || result.ndc_count === 1">
                                        <span x-text="result.ndc || result.ndcs?.[0] || 'N/A'"></span>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                Active Ingredients:
                            </h5>
                            <ul x-show="result.active && Array.isArray(result.active) && result.active.length > 0" class="list-disc list-inside space-y-1 ml-4">
                                <template x-for="(ing, index) in (result.active || [])" :key="index">
                                    <li class="text-sm text-gray-700 dark:text-gray-300" x-show="ing && ing.name">
                                        <span x-text="ing.name || 'Unknown'"></span>
                                        <span class="text-gray-500 dark:text-gray-400" x-show="ing.strength" x-text="'(' + ing.strength + ')'"></span>
                                    </li>
                                </template>
                            </ul>
                            <p x-show="!result.active || !Array.isArray(result.active) || result.active.length === 0" class="text-sm text-gray-500 dark:text-gray-400">N/A</p>
                        </div>
                        
                        <div>
                            <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                Inactive Ingredients:
                            </h5>
                            <ul x-show="result.inactive && Array.isArray(result.inactive) && result.inactive.length > 0" class="list-disc list-inside space-y-1 ml-4">
                                <template x-for="(ing, index) in (result.inactive || [])" :key="index">
                                    <li class="text-sm text-gray-700 dark:text-gray-300" x-text="ing"></li>
                                </template>
                            </ul>
                            <p x-show="!result.inactive || !Array.isArray(result.inactive) || result.inactive.length === 0" class="text-sm text-gray-500 dark:text-gray-400">N/A</p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Section 2: All Remaining Drugs (With Excipients) -->
        <div x-show="filteredResultsWith.length > 0 && resultsFilter === 'all'">
            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-300 mb-2">
                    Section 2: All Remaining Drugs (<span x-text="resultsMetadata.total_with"></span>)
                </h3>
                <p class="text-sm text-yellow-700 dark:text-yellow-400">
                    One or more of your selected excipients were found in these medications. 
                    Matching excipients are highlighted below.
                </p>
            </div>
            <div class="space-y-4">
                <template x-for="result in paginatedResultsWith" :key="result.set_id">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-yellow-500">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-semibold text-gray-900 dark:text-white" x-text="result.title"></h4>
                            <a
                                :href="result.dailymed_link"
                                target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                            >
                                View on DailyMed →
                            </a>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Dosage:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.dosage"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Route:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.route_code_display"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Packager:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.packager"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Drug Type:</span>
                                <span class="text-sm text-gray-900 dark:text-gray-100 ml-2" x-text="result.drug_type"></span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">NDC:</span>
                                <div class="text-sm text-gray-900 dark:text-gray-100 ml-2">
                                    <template x-if="result.ndc_count && result.ndc_count > 1">
                                        <div>
                                            <div class="font-medium mb-1">
                                                <span x-text="result.ndc_count"></span> NDC codes:
                                            </div>
                                            <ul class="list-disc list-inside ml-2">
                                                <template x-for="(ndc, idx) in result.ndcs" :key="idx">
                                                    <li x-text="ndc"></li>
                                                </template>
                                            </ul>
                                        </div>
                                    </template>
                                    <template x-if="!result.ndc_count || result.ndc_count === 1">
                                        <span x-text="result.ndc || result.ndcs?.[0] || 'N/A'"></span>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                Active Ingredients:
                            </h5>
                            <ul x-show="result.active && Array.isArray(result.active) && result.active.length > 0" class="list-disc list-inside space-y-1 ml-4">
                                <template x-for="(ing, index) in (result.active || [])" :key="index">
                                    <li class="text-sm text-gray-700 dark:text-gray-300" x-show="ing && ing.name">
                                        <span x-text="ing.name || 'Unknown'"></span>
                                        <span class="text-gray-500 dark:text-gray-400" x-show="ing.strength" x-text="'(' + ing.strength + ')'"></span>
                                    </li>
                                </template>
                            </ul>
                            <p x-show="!result.active || !Array.isArray(result.active) || result.active.length === 0" class="text-sm text-gray-500 dark:text-gray-400">N/A</p>
                        </div>
                        
                        <div>
                            <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                Inactive Ingredients:
                            </h5>
                            <ul x-show="result.inactive && Array.isArray(result.inactive) && result.inactive.length > 0" class="list-disc list-inside space-y-1 ml-4">
                                <template x-for="(ing, index) in (result.inactive || [])" :key="index">
                                    <li 
                                        class="text-sm"
                                        :class="isHighlightedExcipient(ing) ? 'font-bold text-yellow-700 dark:text-yellow-400 bg-yellow-100 dark:bg-yellow-900/30 px-1 rounded' : 'text-gray-700 dark:text-gray-300'"
                                        x-text="ing"
                                    ></li>
                                </template>
                            </ul>
                            <p x-show="!result.inactive || !Array.isArray(result.inactive) || result.inactive.length === 0" class="text-sm text-gray-500 dark:text-gray-400">N/A</p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- No Results -->
        <div x-show="hasSearched && !searching && resultsMetadata.total === 0" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center">
            <p class="text-gray-600 dark:text-gray-400">No results found matching your criteria.</p>
        </div>
        
        <!-- Pagination Controls -->
        <div x-show="hasResults && totalPages > 1" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button
                        @click="previousPage()"
                        :disabled="currentPage === 1"
                        class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-md hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                    >
                        &lt; Previous
                    </button>
                    <span class="text-sm text-gray-700 dark:text-gray-300">
                        Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
                    </span>
                    <button
                        @click="nextPage()"
                        :disabled="currentPage === totalPages"
                        class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-md hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                    >
                        Next &gt;
                    </button>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    <span x-text="itemsPerPage"></span> results/page
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.highlight-excipient {
    background-color: #fef3c7;
    color: #92400e;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
}
.dark .highlight-excipient {
    background-color: rgba(234, 179, 8, 0.3);
    color: #fbbf24;
}
</style>

<script>
function searchApp() {
    return {
        drugQuery: '',
        selectedDrug: '',
        selectedRxcui: '',
        suggestions: [],
        showSuggestions: false,
        autocompleteLoading: false,
        // Excipient selection state
        excipientCategories: {},
        categorySelectedExcipients: {},
        categoryExpanded: {},
        excipientSearchQuery: '',
        excludeInactive: [],  // Track selected excipients for search
        // Results state
        resultsMapFree: new Map(),
        resultsMapWith: new Map(),
        resultsMetadata: {
            total_free: 0,
            total_with: 0,
            total: 0
        },
        excipients_highlighted: [],
        // Filter and sort
        resultsFilter: 'all', // 'all' or 'without'
        sortBy: 'relevance',
        // Pagination
        currentPage: 1,
        itemsPerPage: 25,
        searching: false,
        searchStatus: 'Initializing search...',
        hasSearched: false,
        autocompleteTimeout: null,
        
        async loadExcipientCategories() {
            try {
                const response = await fetch('/api/excipient-categories/');
                if (response.ok) {
                    const data = await response.json();
                    this.excipientCategories = data;
                    // Initialize category selections (empty by default)
                    Object.keys(data).forEach(category => {
                        this.categorySelectedExcipients[category] = [];
                        this.categoryExpanded[category] = false;
                    });
                    console.log('Loaded excipient categories:', Object.keys(data).length, 'categories');
                } else {
                    console.error('Failed to load excipient categories:', response.status);
                    this.excipientCategories = {};
                    this.categorySelectedExcipients = {};
                }
            } catch (error) {
                console.error('Error loading excipient categories:', error);
                this.excipientCategories = {};
                this.categorySelectedExcipients = {};
            }
        },
        
        get filteredExcipientCategories() {
            if (!this.excipientSearchQuery.trim()) {
                return this.excipientCategories;
            }
            const query = this.excipientSearchQuery.toLowerCase();
            const filtered = {};
            Object.keys(this.excipientCategories).forEach(category => {
                const matchingExcipients = (this.excipientCategories[category] || []).filter(exc => 
                    exc.toLowerCase().includes(query) || category.toLowerCase().includes(query)
                );
                if (matchingExcipients.length > 0 || category.toLowerCase().includes(query)) {
                    filtered[category] = matchingExcipients.length > 0 ? matchingExcipients : this.excipientCategories[category];
                }
            });
            return filtered;
        },
        
        filterExcipientCategories() {
            // This method is called on input, but filtering is handled by computed property
            // We can expand matching categories automatically
            if (this.excipientSearchQuery.trim()) {
                const query = this.excipientSearchQuery.toLowerCase();
                Object.keys(this.excipientCategories).forEach(category => {
                    if (category.toLowerCase().includes(query)) {
                        this.categoryExpanded[category] = true;
                    }
                });
            }
        },
        
        toggleCategoryExpanded(category) {
            this.categoryExpanded[category] = !this.categoryExpanded[category];
        },
        
        isCategoryExpanded(category) {
            return this.categoryExpanded[category] || false;
        },
        
        isExcipientSelected(category, excipient) {
            return (this.categorySelectedExcipients[category] || []).includes(excipient);
        },
        
        toggleExcipient(category, excipient) {
            if (!this.categorySelectedExcipients[category]) {
                this.categorySelectedExcipients[category] = [];
            }
            const index = this.categorySelectedExcipients[category].indexOf(excipient);
            if (index > -1) {
                this.categorySelectedExcipients[category].splice(index, 1);
            } else {
                this.categorySelectedExcipients[category].push(excipient);
            }
            this.updateExcludeInactiveFromCategories();
        },
        
        isCategoryFullySelected(category) {
            const selected = this.categorySelectedExcipients[category] || [];
            const total = (this.excipientCategories[category] || []).length;
            return total > 0 && selected.length === total;
        },
        
        toggleCategorySelectAll(category) {
            const allExcipients = this.excipientCategories[category] || [];
            const isFullySelected = this.isCategoryFullySelected(category);
            
            if (isFullySelected) {
                // Deselect all
                this.categorySelectedExcipients[category] = [];
            } else {
                // Select all
                this.categorySelectedExcipients[category] = [...allExcipients];
            }
            this.updateExcludeInactiveFromCategories();
        },
        
        getCategorySelectedCount(category) {
            const selected = this.categorySelectedExcipients[category] || [];
            const total = (this.excipientCategories[category] || []).length;
            return { selected: selected.length, total };
        },
        
        updateExcludeInactiveFromCategories() {
            // Rebuild excludeInactive from all category selections
            const categoryExcipients = new Set();
            Object.values(this.categorySelectedExcipients).forEach(excipients => {
                excipients.forEach(exc => categoryExcipients.add(exc));
            });
            
            // Update excludeInactive to match category selections
            this.excludeInactive = Array.from(categoryExcipients);
        },
        
        get totalSelectedExcipients() {
            return Object.values(this.categorySelectedExcipients).reduce((sum, excipients) => sum + excipients.length, 0);
        },
        
        canSearch() {
            return this.drugQuery.trim().length > 0 && !this.searching;
        },
        
        // Detect input type: NDC, Set ID, Drug Class, or Drug Name
        detectInputType(query) {
            const trimmed = query.trim();
            
            // Check for Set ID (UUID format)
            const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (uuidPattern.test(trimmed)) {
                return 'setid';
            }
            
            // Check for NDC (9-11 digits, may have dashes)
            // Formats: 12345-678-90 (11), 12345-678-9 (10), 12345-6789 (9), 1234-5678-90 (10), etc.
            // NDC codes are typically 9-11 digits total
            const ndcPattern = /^[\d-]{8,12}$/; // Allow 8-12 characters (to account for dashes)
            const digitsOnly = trimmed.replace(/-/g, '');
            // NDC codes have 9, 10, or 11 digits
            if (ndcPattern.test(trimmed) && digitsOnly.length >= 9 && digitsOnly.length <= 11 && /^\d+$/.test(digitsOnly)) {
                return 'ndc';
            }
            
            // Check for Drug Class Code (typically alphanumeric codes)
            // This is a heuristic - if it looks like a code (short, alphanumeric, no spaces)
            // and doesn't match NDC or Set ID, it might be a drug class code
            // For now, we'll treat it as drug name and let the backend handle it
            // The backend can search by drug_class_code if needed
            
            // Default to drug name
            return 'drug';
        },
        
        async handleDrugInput(event) {
            const query = event.target.value.trim();
            
            if (this.selectedDrug && query !== this.selectedDrug) {
                this.selectedDrug = '';
                this.selectedRxcui = '';
            }
            
            // Check if input looks like NDC, Set ID, or Drug Class - skip autocomplete for these
            const inputType = this.detectInputType(query);
            if (inputType === 'ndc' || inputType === 'setid') {
                // Don't show autocomplete for NDC or Set ID
                this.suggestions = [];
                this.showSuggestions = false;
                this.autocompleteLoading = false;
                if (this.autocompleteTimeout) {
                    clearTimeout(this.autocompleteTimeout);
                    this.autocompleteTimeout = null;
                }
                return;
            }
            
            if (this.autocompleteTimeout) {
                clearTimeout(this.autocompleteTimeout);
                this.autocompleteTimeout = null;
            }
            
            // Only show autocomplete for drug names (2+ characters)
            if (query.length >= 2) {
                this.showSuggestions = false;
                const currentQuery = query;
                
                this.autocompleteTimeout = setTimeout(async () => {
                    const finalQuery = this.drugQuery.trim();
                    
                    // Double-check it's still a drug name (not NDC/Set ID)
                    const finalInputType = this.detectInputType(finalQuery);
                    if (finalInputType === 'ndc' || finalInputType === 'setid') {
                        this.suggestions = [];
                        this.showSuggestions = false;
                        this.autocompleteLoading = false;
                        this.autocompleteTimeout = null;
                        return;
                    }
                    
                    if (finalQuery.length >= 2 && finalQuery === currentQuery) {
                        this.autocompleteLoading = true;
                        
                        try {
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 5000);
                            
                            const response = await fetch(`/api/drug-autocomplete/?q=${encodeURIComponent(finalQuery)}`, {
                                signal: controller.signal
                            });
                            clearTimeout(timeoutId);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            const data = await response.json();
                            this.suggestions = data || [];
                            this.showSuggestions = data && data.length > 0;
                        } catch (error) {
                            if (error.name === 'AbortError') {
                                console.error('Autocomplete request timed out');
                            } else {
                                console.error('Error fetching suggestions:', error);
                            }
                            this.suggestions = [];
                            this.showSuggestions = false;
                        } finally {
                            this.autocompleteLoading = false;
                        }
                    } else {
                        this.autocompleteLoading = false;
                    }
                    this.autocompleteTimeout = null;
                }, 1000);
            } else {
                this.suggestions = [];
                this.showSuggestions = false;
                this.autocompleteLoading = false;
            }
        },
        
        selectDrug(suggestion) {
            this.selectedDrug = suggestion.label;
            this.drugQuery = suggestion.label;
            this.selectedRxcui = suggestion.value || '';
            this.showSuggestions = false;
        },
        
        generateGroupingKey(result) {
            const activeNames = (result.active || [])
                .map(ing => ing.name || '')
                .filter(name => name)
                .sort()
                .join('|');
            
            const inactiveNames = (result.inactive || [])
                .filter(name => name)
                .sort()
                .join('|');
            
            const packager = result.packager || 'N/A';
            const drugType = result.drug_type || 'N/A';
            
            return `${activeNames}||${inactiveNames}||${packager}||${drugType}`;
        },
        
        addOrMergeResult(result, category) {
            const key = this.generateGroupingKey(result);
            const targetMap = category === 'free' ? this.resultsMapFree : this.resultsMapWith;
            
            if (targetMap.has(key)) {
                const existing = targetMap.get(key);
                const ndc = result.ndc || 'N/A';
                if (!existing.ndcs.includes(ndc)) {
                    existing.ndcs.push(ndc);
                    existing.ndc_count = existing.ndcs.length;
                }
                if (result.set_id && !existing.grouped_set_ids.includes(result.set_id)) {
                    existing.grouped_set_ids.push(result.set_id);
                }
            } else {
                const ndc = result.ndc || 'N/A';
                targetMap.set(key, {
                    ...result,
                    ndcs: [ndc],
                    ndc_count: 1,
                    grouped_set_ids: [result.set_id]
                });
            }
        },
        
        async performSearch() {
            if (!this.canSearch()) {
                return;
            }
            
            const searchQuery = this.drugQuery.trim();
            
            // Reset results
            this.resultsMapFree.clear();
            this.resultsMapWith.clear();
            this.resultsMetadata = { total_free: 0, total_with: 0, total: 0 };
            this.excipients_highlighted = [];
            this.resetPagination();
            this.searching = true;
            this.hasSearched = true;
            this.searchStatus = 'Initializing search...';
            
            try {
                // Detect input type
                const inputType = this.detectInputType(searchQuery);
                
                // Build URL
                let url = '/api/search/';
                const params = new URLSearchParams();
                
                // Handle different input types
                if (this.selectedRxcui) {
                    // Autocomplete was used - prefer RxCUI
                    params.append('rxcui', this.selectedRxcui);
                    if (this.selectedDrug) {
                        params.append('drug', this.selectedDrug);
                    }
                } else {
                    // No autocomplete - use detected input type
                    if (inputType === 'setid') {
                        params.append('setid', searchQuery);
                    } else if (inputType === 'ndc') {
                        // Keep NDC with dashes - DailyMed API prefers this format
                        params.append('ndc', searchQuery);
                    } else {
                        // Default to drug name (includes drug class names)
                        params.append('drug', searchQuery);
                    }
                }
                
                url += '?' + params.toString();
                
                // Add exclude-inactive (excipients to avoid)
                if (this.excludeInactive.length > 0) {
                    url += `&exclude-inactive=${encodeURIComponent(this.excludeInactive.join(','))}`;
                }
                
                // Fetch all results
                url += `&pagesize=1000`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        
                        try {
                            const data = JSON.parse(line);
                            
                            if (data.type === 'init') {
                                this.excipients_highlighted = data.excipients_highlighted || [];
                                this.searchStatus = 'Searching for drugs...';
                            } else if (data.type === 'result') {
                                if (data.result) {
                                    if (!Array.isArray(data.result.active)) {
                                        data.result.active = [];
                                    }
                                    data.result.active = data.result.active.filter(ing => 
                                        ing && typeof ing === 'object' && ing.name
                                    );
                                    
                                    if (!Array.isArray(data.result.inactive)) {
                                        data.result.inactive = [];
                                    }
                                }
                                
                                // Add ALL results (both free and with excipients)
                                this.addOrMergeResult(data.result, data.category);
                                
                                if (data.metadata) {
                                    this.resultsMetadata = {
                                        total_free: data.metadata.total_free || 0,
                                        total_with: data.metadata.total_with || 0,
                                        total: data.metadata.total || 0
                                    };
                                }
                                
                                const currentTotal = this.resultsMapFree.size + this.resultsMapWith.size;
                                this.searchStatus = `Found ${currentTotal} result${currentTotal !== 1 ? 's' : ''}...`;
                                
                            } else if (data.type === 'complete') {
                                if (data.metadata) {
                                    this.resultsMetadata = data.metadata;
                                }
                                
                                const totalResults = this.resultsMapFree.size + this.resultsMapWith.size;
                                this.searchStatus = `Search complete! Found ${totalResults} result${totalResults !== 1 ? 's' : ''}.`;
                                this.currentPage = 1;
                                this.sortResults();
                            } else if (data.type === 'error') {
                                throw new Error(data.error || 'Unknown error occurred');
                            }
                        } catch (parseError) {
                            console.error('Error parsing stream data:', parseError, 'Line:', line);
                        }
                    }
                }
                
                if (buffer.trim()) {
                    try {
                        const data = JSON.parse(buffer);
                        if (data.type === 'complete' && data.metadata) {
                            this.resultsMetadata = data.metadata;
                        }
                    } catch (e) {
                        console.error('Error parsing final buffer:', e);
                    }
                }
                
            } catch (error) {
                console.error('Error performing search:', error);
                alert('An error occurred while searching. Please try again.');
                this.resultsMapFree.clear();
                this.resultsMapWith.clear();
                this.resultsMetadata = { total_free: 0, total_with: 0, total: 0 };
            } finally {
                this.searching = false;
            }
        },
        
        isHighlightedExcipient(ingredient) {
            if (!this.excipients_highlighted) return false;
            const ingLower = ingredient.toLowerCase();
            return this.excipients_highlighted.some(exc => 
                ingLower.includes(exc.toLowerCase()) || exc.toLowerCase().includes(ingLower)
            );
        },
        
        sortResults() {
            // Sort results based on sortBy value
            const freeArray = Array.from(this.resultsMapFree.values());
            const withArray = Array.from(this.resultsMapWith.values());
            
            const sortFunction = (a, b) => {
                if (this.sortBy === 'name') {
                    return (a.title || '').localeCompare(b.title || '');
                } else if (this.sortBy === 'packager') {
                    return (a.packager || '').localeCompare(b.packager || '');
                } else {
                    // Relevance: free results first, then by name
                    return 0; // Already sorted by category
                }
            };
            
            freeArray.sort(sortFunction);
            withArray.sort(sortFunction);
            
            // Rebuild maps with sorted order
            this.resultsMapFree.clear();
            this.resultsMapWith.clear();
            
            freeArray.forEach(result => {
                const key = this.generateGroupingKey(result);
                this.resultsMapFree.set(key, result);
            });
            
            withArray.forEach(result => {
                const key = this.generateGroupingKey(result);
                this.resultsMapWith.set(key, result);
            });
        },
        
        get allResults() {
            const free = Array.from(this.resultsMapFree.values()).map(r => ({...r, category: 'free'}));
            const withResults = Array.from(this.resultsMapWith.values()).map(r => ({...r, category: 'with'}));
            return [...free, ...withResults];
        },
        
        get filteredResultsFree() {
            return Array.from(this.resultsMapFree.values()).map(r => ({...r, category: 'free'}));
        },
        
        get filteredResultsWith() {
            return Array.from(this.resultsMapWith.values()).map(r => ({...r, category: 'with'}));
        },
        
        get paginatedResults() {
            let results = [];
            if (this.resultsFilter === 'all') {
                results = this.allResults;
            } else {
                results = this.filteredResultsFree;
            }
            
            const start = (this.currentPage - 1) * this.itemsPerPage;
            const end = start + this.itemsPerPage;
            return results.slice(start, end);
        },
        
        get paginatedResultsFree() {
            return this.paginatedResults.filter(r => r.category === 'free');
        },
        
        get paginatedResultsWith() {
            return this.paginatedResults.filter(r => r.category === 'with');
        },
        
        get totalPages() {
            let totalResults = 0;
            if (this.resultsFilter === 'all') {
                totalResults = this.resultsMapFree.size + this.resultsMapWith.size;
            } else {
                totalResults = this.resultsMapFree.size;
            }
            return Math.ceil(totalResults / this.itemsPerPage);
        },
        
        get hasResults() {
            return this.resultsMapFree.size > 0 || this.resultsMapWith.size > 0;
        },
        
        goToPage(page) {
            if (page >= 1 && page <= this.totalPages) {
                this.currentPage = page;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },
        
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.goToPage(this.currentPage + 1);
            }
        },
        
        previousPage() {
            if (this.currentPage > 1) {
                this.goToPage(this.currentPage - 1);
            }
        },
        
        resetPagination() {
            this.currentPage = 1;
        }
    }
}
</script>
{% endblock %}
